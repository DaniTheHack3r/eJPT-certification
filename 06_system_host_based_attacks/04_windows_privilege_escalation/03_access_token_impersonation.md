# Access Token Impersonation

## Windows Access Token

- Windows access tokens are a core element of the authentication process on Windows and are created and managed by the Local Security Authority Subsystem Service (LSASS).

- A Windows access token is responsible for identifying and describing the security context of a process or thread running on a system. Simply put, an access token can be thought of as a temporary key akin to a web cookie that provides users with access to a system or network resource without having to provide credentials each time a process is started or a system resource is accessed.

- Access tokens are generated by the winlogon.exe process every time a user authenticates successfully and includes the identity and privileges of the user account associated with the thread or process. This token is then attached to the userinit.exe process, after which all child processes started by a user will inherit a copy of the access token from their creator and will run under the privileges of the same access token.

- Windows access tokens are categorized based on the varying security levels assigned to them. These security levels are used to determine the privileges that are assigned to a specific token.

- An access token will typically be assigned one of the following security levels:
    + Impersonate-level tokens are created as a direct result of a non-interactive login on Windows, typically through specific system services or domain logons.
    + Delegate-level tokens are typically created through an interactive login on Windows, primarily through a traditional login or through remote access protocols such as RDP.

- Impersonate-level tokens can be used to impersonate a token on the local system and not on any external systems that utilize the token.

- Delegate-level tokens pose the largest threat as they can be used to impersonate tokens on any system.

## Windows Privileges

- The process of impersonating access tokens to elevate privileges on a system will primarily depend on the privileges assigned to the account that has been exploited to gain initial access as well as the impersonation or delegation tokens available.

- The following are the privileges that are required for a successful impersonation attack:
    + SeAssignPrimaryToken: This allows a user to impersonate tokens.
    + SeCreateToken: This allows a user to create an arbitrary token with administrative privileges.
    + SeImpersonatePrivilege: This allows a user to create a process under the security context of another user typically with administrative privileges.

**Note**: We are looking for privileged tokens that we can impersonate.

## The Incognito Module

- Incognito is a built-in meterpreter module that was originally a standalone application that allows you to impersonate user tokens 
after successful exploitation.

- We can use the incognito module to display a list of available tokens that we can impersonate.

**Note**: There are other methods like the one called potato attack to escale privileges using token impersonation.

## Laboratory

### Initial Access

- We start by performing an Nmap scan on the target.

- We will take advantage of any vulnerability present on the target machine in order to get inital access by establishing a meterpreter or command shell session. In this case the vulnerability is in one of the services running on the target machine in port 80.

- You should identify a file sharing service called HFS on port 80 developed by Rejetto. Use MSFconsole in order to exploit the service and get initial access. Set the required options and run the exploit.

**Note**: use the search command in msfconsole to look up the desired module.

**Note**: remember you can set global options when you start the msfconsole by running `setg OPTION VALUE`.

- Once you have access to the target machine through a meterpreter session, perform some basic local enumeration to know what version of windows is running, what user we have access to, level of privilege, etc. Running `sysinfo` could reveal some useful information about the machine, `getuid` will give you the name of the user, if it is `Administrator`, good for you as it is a privileged account. In any other case, you could check if the current user you have access has one of the two necessary privileges to impersonate tokens with incognito: `SeImpersonatePrivilege` or `SeAssignPrimaryTokenPrivilege`. Run `getprivs` in the meterpreter shell to see if the account has it, if so, go to the next step.

**Note**: if you injected an x86 meterpreter session and the target is running on x64, you can run `pgrep explorer` to get the pid of the explorer and migrate your meterpreter session to that pid using `migrate $EXPLORER_PID`. However, any process running x64 should be enough.

**Note**: You could get an `Access is Denied` error message and that could be a problem when you try to migrate to another service if you need priveleges to migrate to it like an administrative account. In that case you should try escalating privileges.

### Token Impersonation

- We just need to start the incognito module in our meterpreter session, using the command `load incognito`.

**Note**: if for any reason meterpreter dies, just try the connection again.

- Once the incognito module has loaded, run `list_tokens -u` to get a list of delegation tokens and impersonation tokens available. In terms of access tokens avilable, we could see that the Administrator token is under the Delegation Tokens List. That token should be enough to escalate privileges on that system and any other system.

- Now we run the command `impersonate_token "$TOKEN_NAME"` and we can check that the impersonation was successful by running `getuid`.

- Finally run `getprivs` to get the privileges of the account. You should get an error at this point of `Access is Denied` as you you should migrate your meterpreter session to another process, which explorer is the most recommended process to migrate to. And run `getprivs` again to see the privileges.

**Note**: The success of this attack will highly depend on what user accounts are currently on the system, what privileges do they have and if they have privileged access outside of the local administrator group. It doesn't have to belong to a particular user it could belong to NT AUTHORITY/LOCAL SERVICE or NT AUTHORITY/SYSTEM as well.

**Note**: you could fall into a situation where no token impersonation are available. In that case, you will use the potato attack that will help you generate NT AUTHORITY/SYSTEM Acess Token that you can impersonate.

**Note**: You will also find out that when you escalate privileges you will see more access token available for you to impersonate like the `NT AUTHORITY/SYSTEM`.

Flag: x28c832a39730b7d46d6c38f1ea18e12