# Windows Kernel Exploits

- Privilege escalation is the process of exploiting vulnerabilities or misconfigurations in systems to elevate privileges from one user to another, typically to a user with administrative or root access on a system.

- Privilege escalation is a vital element of the attack life cycle and is a major determinant in the overall success of a penetration test. 

- After gaining an initial foothold on a target system you will be required to elevate your privileges in order to perform tasks and functionality that require administrative privileges.

- The importance of privilege escalation in the penetration testing process cannot be overstated or overlooked. Developing your privilege escalation skills will mark you out as a good penetration tester.

## Windows Kernel

- A Kernel is a computer program that is the core of an operating system and has complete control over every resource and hardware on a system. It acts as a translation layer between hardware and software and facilitates the communication between these two layers.

- Windows NT is the kernel that comes pre-packaged with all versions of Microsoft Windows and operates as a traditional kernel with a few exceptions based on user design philosophy. It consists of two main modes of operation that determine access to system resources and hardware:
    + User Mode – Programs and services running in user mode have limited access to system resources and functionality.
    + Kernel Mode – Kernel mode has unrestricted access to system resources and functionality with the added functionality of managing devices and system memory.

- Kernel exploits on Windows will typically target vulnerabilities In the Windows kernel to execute arbitrary code in order to run privileged system commands or to obtain a system shell.

- Privilege escalation on Windows systems will typically follow the following methodology:
    + Identifying kernel vulnerabilities.
    + Downloading, compiling and transferring kernel exploits onto the target system.

**Note**: Kernel exploitation could be very damaging to the target system, they could crash it or even cause loss of data. That's why it needs to be used carefully, knowing the operating system you are target and the kernel vulnerabilities that could be exploited on the system.

- Windows-Exploit-Suggester - This tool compares a targets patch levels against the Microsoft vulnerability database in order to detect potential missing patches on the target. It also notifies the user if there are public exploits and Metasploit modules available for the missing bulletins.
    + GitHub: https://github.com/AonCyberLabs/Windows-Exploit-Suggester

- Windows-Kernel-Exploits - Collection of Windows Kernel exploits sorted by CVE.
    + GitHub: https://github.com/SecWiki/windows-kernel-exploits/tree/master/MS16-135

**Note**: The techniques demonstrated in this video are performed on a Windows 7 SP1 VM.

## Laboratory

**Note**: There is not a laboratory instance available as the exploits treated here could potentially break machines or could be used to abuse instances in the cloud.

**Context**: You already have access (as user Accountant) to the target machine and established a meterpreter session as well, however, the privileges you have are very limited and the main goal is to escalate privileges.

- The first step for this laboratory is to identify kernel vulnerabilities using the metasploit console.

**Note**: The meterpreter session established could be used to get privileged access by automated tools it already provides. However, if all of those fail, we can still try to exploit any kernel vulnerability.

## MSF

- For this task we will use a post exploitation module called `post/multi/recon/local_exploit_suggester`. This module will help us enumerate known vulnerabilities for the target machine OS version (Not only Windows). We need to set the established meterpreter session in the option `SESSION` and run it. It will return a list of exploits that the target appears to be vulnerable, including the name of the msf module.

**Note**: Not all enumerated exploits are kernel exploits, it is heavily recommended to properly investigate every exploit on the list in order to get some context on what you could do with it and gather a little bit more of information of the target machine regarding that exploit.

- For this case of all modules we will use `exploit/windows/local/ms16_014_wmi_recv_notif` that will abuse a vulnerability in the MSI subsystem. We only need to set the option SESSION in order to be able to inject the meterpreter payload properly and the LPORT the session is going to use to connect. This could fail nonetheless, and then it will be necessary to try another vulnerability.

## Windows Exploit Suggester

- This is a python script https://github.com/AonCyberLabs/Windows-Exploit-Suggester, you can follow the instructions inside the repository to run the suggester. For it to run, you need to have access so you can get the `systeminfo` command output.

**Note**: It will enumerate a list of exploits for the windows machine systeminfo you set. In the list the first vulnerabilities are the ones with higher chance of success.

- After we choose the kernel vulnerabilities we would like to exploit, we can make other searches in google and github. We can use the repository https://github.com/SecWiki/windows-kernel-exploits/ to find more info about the vulnerability, these vulnerabilities are sorted by CVE.

**Note**: As these payloads are PoC that simulate a malicious code, antimalware could detect them as dangerous or malicious files. So you need a bit of understanding of antimalware bypassing.

**Note**: If you use the meterpreter session in order to execute malicious code, always remember to use the Temp directory, never use the home directory of the target system because home directories are commonly accessed by regular users and you could be detected.

- In this case we wiil use the vulnerability https://github.com/SecWiki/windows-kernel-exploits/tree/master/MS16-135 which is really effective to escalate privileges. Just paste it in the Temp directory using your non privileged meterpreter session and follow the instructions of the script. In this case: `.\41015.exe 7`.

**Note**: Never use these exploits in production or enterprise environments, as it could cause problems or crashes and it is something we don't want. Unless you know the exploit is relatively stable, it is not recommended to use it in those environments.