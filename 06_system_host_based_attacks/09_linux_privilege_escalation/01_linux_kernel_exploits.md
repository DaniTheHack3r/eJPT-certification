# Linux Kernel Exploits

- Kernel exploits on Linux will typically target vulnerabilities In the Linux kernel to execute arbitrary code in order to run privileged system commands or to obtain a system shell.

- This process will differ based on the Kernel version and distribution being targeted and the kernel exploit being used.

- Privilege escalation on Linux systems will typically follow the following methodology:
    + Identifying kernel vulnerabilities
    + Downloading, compiling and transferring kernel exploits onto the target system.

## Tools & Environment

- Linux-Exploit-Suggester - This tool is designed to assist in detecting security deficiencies for given Linux kernel/Linux-based machine. It assesses (using heuristics methods) the exposure of the given kernel on every publicly known Linux kernel exploit.
    + GitHub: https://github.com/mzet-/linux-exploit-suggester

**Note**: The techniques demonstrated in this video are performed on an Ubuntu 12.04 VM.

**Note**: Kernel exploits target the actual kernel of the OS, remember this is the core of the operating system, and if you run kernel exploits that are not compatible with the specific version running on the target, it could lead to crashes or kernel panic which could lead to data loss. This is very important to take into consideration in productive environments.

## Laboratory

### Kernel enumeration

We must start by having a meterpreter session running on the target.

- We will start by performing local enumeration. Run `sysinfo`, the Ubuntu Version should be 12.04 and the kernel version should be Linux 3.2.0-23-generic. Run `getuid` and it should show you what privileges you have, in this case the should be associated with the user www-data.

**Note**: www-data is a service account that is commonly seen in linux web servers and it is essentially used to manage a web server like apache or nginx. It is there in order to prevent privileged access if the servers are exploited somehow.

**Note**: it doesn't matter if you have a meterpreter session running x86-32 bits and the target has x64 in this particular context.

- Now to get a little bit more of information, run `shell` to active the unix shell and try to enumerate a little bit more about www-data and other users. Including running `groups www-data` and `cat /etc/passwd`. 

**Note**: In linux, if you active the shell from meterpreter, remember to run `/bin/bash -i` to start a bash shell.

**Note**: If you, for exapmle, try to update all the repositories, you will notice that you don't even have permissions to use sudo with www-data so you need to elevate your privileges preferable to root as it is the highest privilege in the system.

- The script we are going to use is the `linux-exploit-suggester` https://github.com/mzet-/linux-exploit-suggester. It is recommended to download it in your penetration testing distribution first and then transfering it to the target machine and into the /tmp directory.

**Note**: With an active meterpreter session, it is pretty easy to transfer the exploit suggester to the target machine.

- Once we transfer it, we need to execute it using the bash shell. Run `chmod -x les.sh` to add executable permissions to the shell script and the execute it using `./les.sh`. It will enumerate many things like information about the target machine and operating system, known vulnerabilities for that particular system including the CVE number, but in terms of kernel exploitation, the most important things are:
    + Kernel version.
    + Architecture.
    + Distribution.
    + Distribution Version.

**Note**: Dirtycow and Dirtycow 2 (CVE-2016-5195) are the vulnerabilities we are going to take a look at in this case.

- The first step is to download the exploit code and edit it as we'd like it to be. In this case, the exploit helps you create a new privileged user. You can change the name of the user if you want and then compile the code in C before transfering the binary to the target machine.

**Note**: To compile C code you need the compiler called `gcc`.

**Note**: Sometimes the kernel exploit won't have compilation instructions and you might need to research that.

**Note**: Test uploading the binary to the target machine, otherwise, you'll probably need to upload the C code and then compile it in the target machine, you will notice it as you will receive compatibility errors, rather than a crash.

- If everything ran successfully, you will have a new user that you can use to escalate privileges. It will tell you to check the `/etc/passwd` file to check if the user exists and then log in with that user. This new user should belong to the root group and should be able to run administrative commands using `sudo` and read files like the shadow file `/etc/shadow` which contains the hash password.

**Note**: Consider that you need to understand how to look for kernel exploits and vulnerabilities instead of memorizing how to exploit a system in particular.
