# Exploiting SAMBA

- SMB (Server Message Block) is a network file sharing protocol that is used to facilitate the sharing of files and peripherals between computers on a local network (LAN).

- SMB uses port 445 (TCP). However, originally, SMB ran on top of NetBIOS using port 139.

- Samba is the Linux implementation of SMB, and allows Windows systems to access Linux shares and devices.

**Note**: It is good to understand that SAMBA doesn't come prepackaged in any linux distribution, as it is not common because it is used to give windows machines access to linux shares. So it could probably be found in corporate networks by linux servers.

- SAMBA utilizes username and password authentication in order to obtain access to the server or a network share.

- We can perform a brute-force attack on the SAMBA server in order to obtain legitimate credentials.

- After obtaining legitimate credentials, we can use a utility called SMBMap in order to enumerate SAMBA share drives, list the contents of the shares as well as download files and execute remote commands on the target.

- We can also utilize a tool called smbclient. smbclient is a client that is part of the SAMBA software suite. It communicates with a LAN Manager server, offering an interface similar to that of the ftp program. It can be used to download files from the server to the local machine, upload files from the local machine to the server as well as retrieve directory information from the server.

## Laboratory

In this laboratory you won't be provided with the target IP address, but you can take your own IP address in the subnet and use the machine in the next ip address. For example x.x.x.2 is your machine and x.x.x.3 is the target.

- Start by performing an nmap scan with service detection. You should see the SAMBA service running in ports 139 (netbios-ssn) or 445 (smb) ports. Actual service versions are not displayed.

- Now we will use hydra to perform the brute force attack. `hydra -L /path/to/username/list -P /path/to/password/list x.x.x.x -t $THREADS $PROTOCOL` in this case the protocol is smb. However, in this case usernames are provided: `admin` and `jane`. So we can rephrase the command as follows: `hydra -l $USERNAME -P /path/to/password/list x.x.x.x -t $THREADS $PROTOCOL`

**Note**: the recommended list is `/usr/share/metasploit-framework/data/wordlists/common_passwords.txt` for passwords.

- Now we will use smbmap, which is a Samba share enumerator, pretty useful to enumerate the contents inside the smb shares like this: `smbmap -H $TARGET_HOST -u $USERNAME -p $PASSWORD`, it will provide you with much information about the shares, including the disks and the permissions you have if you want to access those shares.

- Then we will use smbclient, which is an ftp like client used to browse smb shares, having legitimate credentials. Firstly, we will try to connect to the server and list the shares Like this: `smbclient -L $TARGET_HOST -U $USERNAME` and it will prompt you with the password.

- Now to properly browse the shares, we will use it like this: `smbclient //$TARGET_HOST/$SHARE_NAME -U $USERNAME` and you will be prompted with the password. If you want to see all the commands available, use `?`. For example, you could use `dir` to list the directories inside the share.

**Note**: These techniques and tools can also be used in windows as well.

- Now we will use enum4linux, to get some information about the target machine using SAMBA. It can be executed like this: `enum4linux -a $TARGET_HOST`, the -a option will get all the information gatherable by enum4linux. It will also check if you can connect to SAMBA with a null session or not. To make it much more successful, it is recommended to have legitimate credentials, setting them with options -p for password and -u for the username.
