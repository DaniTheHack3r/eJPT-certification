# Exploiting Microsoft IIS WebDAV

1. Microsoft IIS

  - IIS (Internet Information Services) is a propietary extensible web server software developed by Microsoft for use with the Windows NT family.
  - It can be used to host websites/web apps and provides administrators with a robust GUI for managing websites.
  - IIS can be used to host both static and dynamic web pages developed in ASP.NET and PHP.
  - Typically configured to run on ports 80/443
  - Supported executable file extensions:
    + .asp
    + .aspx
    + .config
    + .php

2. WebDAV

  - WebDAV (Web-based Distributed Authoring and Versioning) is a set of extensions to the HTTP protocol which allow users to collaboratively edit and manage files on remote web servers.
  - WebDAV essentially enables a web server to function as a file server for collaborative authoring.
  - WebDAV runs on top Microsoft IIS on port 80/443.
  - In order to connect to a WebDAV server, you will need to provide legitimate credentials. This is because WebDAV implements authentication in the form of a username and password.

3. WebDAV Exploitation

  - The first step of the exploitation process will involve identifying whether WebDAV has been configured to run on the IIS web server.
  - We can perform a brute-force attack on the WebDAV server in order to identify legitimate credentials that we can use for authentication.
  - After obtaining legitimate credentials, we can authenticate with the WebDAV server and upload a malicious .asp payload that can be used to execute arbitrary commands or obtain a reverse shell on the target.

4. Tools

  - davtest - Used to scan, authenticate and exploit a WebDAV server.
    + Pre-installed on most offensive penetration testing distribution like Kali and Parrot OS.
  - cadaver - cadaver supports file upload, download, on-screen display, in-place editing, namespace operations (move/copy), collection creation and deletion, property manipulation, and resource locking on WebDAV servers.
    + Pre-installed on most offesive penetration testing distributions like Kali and Parrot OS.
  
**Note**: All techniques demonstrated in this course are performed on Kali Linux.

5. Laboratory

  - Start the lab just performing a simple nmap scan. Include -sV and -sC to get some more info about the target port.

  **Note**: In the default scripts of Nmap is run a http-webdav-scan, it is not pretty useful but you can get an idea of what is running there.

  - We can get even more info with the script `http-enum` like whether webdav is configured or not and whether we have a webdav directory there.
  - If we get the webdav directory we can then go and try it out in the browser.

  **Note**: In this lab the webdav server is exposed but works with simple authentication, for this lab in particular we have received credentials so there's no need to brute force the password.

  - If we want to perform brute force to the webdav server, we can use hydra. As we have to perform brute force with the username as well, we can specify the common users list `/usr/share/wordlists/metasploit/common_users.txt` and the common password list `/usr/share/wordlists/metasploit/common_passwords.txt`. We must also provide the ip address, the port and methods which are `http-get` and the path. It goes like this: `hydra -L <user_list> -P <password_list> <ip-address | domain> <port>-<method> <path>`.

  **Note**: These lists are pretty simple, in a real penetration testing they might not work. It is recommended to do some reconnaissance in order to get users that you know they are going to be valid and search for more comprehensive password lists out there to figure out proper crendentials.

  **Note**: When we get access to the webdav server in the browser, we are pretty sure we can begin performing some tests over the webdav server. We can start using davtest utility that comes prepackaged with kali linux.

  - We can start performing some testing with davtest. Running a simple command we can enumerate some info about webdav `davtest -url <web-url>/<dav-dir>/`. In this case we receive the same information as before, just that the directory exists but with no access as it requires credentials.
  
  - Then we can try using the credentials we already have, like this `davtest -url <web-url>/<dav-dir>/ -auth <username>:<password>`. It will start peforming some checks to see if we can create a directory, what kind of files we can upload, modify, download and if we can perform RCE.
  
  **Note**: In this lab we can see that we can perform RCE using an asp file. This could be useful to exploit the machine and get some access with cadaver.

  - Cadaver is a webdav penetration testing tool that works like an agent to establish a connection with the webdav server. It can be initialized with just `cadaver <web-url>/<webdav-dir>` and it will ask you for credentials.

  **Note**: As cadaver works as an client for webdav, we can upload files to the webdav server. In this case we are going to upload an asp file to perform RCE.

  **Note**: Kali linux comes prepackage with a serie of webshells in `/usr/share/webshells`.

  - As we only need to update the asp webshell to the webdav server using cadaver, we can do it from the established connection with webdav server using the command put `put /usr/share/webshells/asp/webshell.asp`.

  - Then we can come back to the web browser and look for the uploaded webshell in the directory we already had access to. From there we can just click the webshell to execute it and it will give us remote code execution capabilities.

  **Note**: Take in to consideration that it is a windows system and you must use the commands available for windows.

  flag found in C:\flag.txt: 0cc175b9c0f1b6a831c399e269772661