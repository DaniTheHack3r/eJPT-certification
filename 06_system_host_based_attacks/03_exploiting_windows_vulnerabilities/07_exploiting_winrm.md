# Exploiting WinRM

WinRM is the Windows Remote Management Protocol. Not configured by default but usuable in many windows versions. It works over HTTP and HTTPS.

Thought as a feature for system administrators, it will be utilized by them to properly control and manage group of windows systems. It can also be used through internet, for example, to get into a windows server and remote control de system through cmd, however, it is not the typical deployment case.

The only thing needed to properly utilize this protocol as a windows administrator is to have an administrator account in the remote machine. With only username and password the administrators can connect to the windows machine in the network using winRM and execute commands over there. However, it can utilize other forms of authentication.

**Note**: to connect to winRM you don't need the clear-text password, you can use the hash and it should work as well.

It usually runs in ports 5985 (HTTP) and 5986 (HTTPS).

Common tools used to crack WinRM are `crackmapexec`, used to perform brute-force attacks on WinRM to identify users and their passwords as well as to execute commands on the target system. And `evil-winrm` which is a ruby script that can be used to establish a command shell session on the target.

Alternatively we can establish a meterpreter session using msf console.

## Laboratory

- First step is performing an Nmap scan in order to identify if WinRM is enabled in the target system. Remember passing WinRM ports as arguments as Nmap by default only scans the 1000 most common well-known ports.
**Note**: Don't pay attention to the banner returned by the Nmap scan in those ports as WinRM doesn't present banners when connection to the service.

- Now execute `crackmapexec` on the terminal. We can attack winRM with the following command `crackmapexec winrm x.x.x.x -u $USERNAME|$USERLIST -p $PASSWORD|$PASSWORDLIST`.

**Note**: crackexecmap is a toolbox rather than just a tool, so it will be used many times for different use cases when pentesting networks.
**Note**: We are targeting the administrator account for this demonstration as we definetly know that the administrator account is there becuase is the first user account that is created during windows installation. Also we know that is the account that administrator use to access the system. And finally, we will have escalated privileges if we get access to that account.
**Note**: WinRM is basically an implementation os wsman (windows management api). You will notice that crackmapexec connects using that protocol.

result: WINRM       10.4.28.183     5985   NONE             [+] None\administrator:tinkerbell (Pwn3d!)

- After a successful brute force attack, we could use the password in order to access the system using crackmapexec to execute commands remotely `crackmapexec winrm 10.2.18.45 -u $USER -p $PASSWORD -x "$COMMAND"`.

**Note**: Remember that any command that you execute will be logged into the system and visible by log viewers or IDS.
**Note**: We are not really exploiting a system vulnerability, we just performed a brute force attack a guessed the password for the administrator account, and now we are legitimate executing commands on the target machine.
**Note**: When connection to WinRM, you should not have any restriction, as firewall rules will be added to allow that protocol.

- Now we will use `evil-winrm.rb` to establish a command shell session with the following command `evil-winrm.rb -u $USERNAME -p '$PASSWORD' -i 10.2.18.45`. 

- Now to establish a meterpreter session we will use the msf console module `exploit/windows/winrm/winrm_script_exec`. When selecting it, it will default to x86 meterpreter payload. For this module we will only need to fill RHOST, USERNAME and PASSWORD, and we will need to set the FORCE_VBS option to true, this option forces the use of a Visual Basic Command Stager.

**Note**: The MSF module may not work and you will have to retry sometimes.

Flag: 3c716f95616eec677a7078f92657a230