# Pivoting

+ Pivoting is a post exploitation technique that involves utilizing a compromised host to attack other systems on the compromised host’s private internal network.

+ After gaining access to one host, we can use the compromised host to exploit other hosts on the same internal network to which we could not access previously.

**Note**: This action of pivoting is important to get to other machines with important information and relevant privileges.

+ Meterpreter provides us with the ability to add a network route to the internal network’s subnet and consequently scan and exploit other systems on the network.

**Note**: Check page 163 of the pdf for pivoting representation.

## Laboratory

**Note**: We are going to receive two victim ip addresses. The victim 1 is accesible by us through the net, but victim 2 is not.

- Start the postgresql server by running `service postgresql start`.

- Start the msfconsole and check the database status.

- Create a new workspace and import your nmap scan results. We can name it pivoting for this example.

**Note**: We don't need to set globally the RHOSTS as we have 2 targets.

- We can start by using db_nmap to start scanning the victim 1 machine. Or you can import them from an external xlm nmap result file.

- Service: Rejetto2.3. Exploit found: `exploit/windows/http/rejetto_hfs_exec`. Get access to the target machine with a meterpreter session. Set the meterpreter, reverse_tcp payload, to the x64 version for windows.

- Let's try local enumeration: `sysinfo`, `getuid`, `getprivs`. Consider the user you are currently logged in at, it should be Administrator.

- Now we are going to establish a new route using meterpreter and the network address that can be calculated from the machine address and the subnetmask represented in the ipconfig of the target machine. From meterpreter run `run autoroute -s $TARGET_NETWORK_ADDRESS`.

**Note**: At this point we can set a name for the session of id 1 by running `sessions -n victim-1 -i 1`.

- We will use the msfconsole to scan other targets using the compromised victim 1. We can't use external tools as we established the route using meterpreter. Now we can add the address of the victim 2 as RHOSTS in the module `auxiliary/scanner/portscan/tcp` and hit run. Port 80 should be open. As we cannot access directly to the victim 2 machine, we won't be able to see the contents of the target by using the browser.

- To directly scan the second target, we will need to add a port forwarding rule on the victim 1 machine using meterpreter. This can be done as we know what ports are open on the victim 2. Go to meterpreter and run `portfwd add -l 1234 -p 80 -r $VICTIM_2_IP_ADDRESS` this will forward from 1234 in our machine to 80 on the victim 2 machine.

- Now run from the msfconsole `db_nmap -sS -sV -p 1234 $OUR_IP_ADDRESS`. Bad blue should be running on port 80 on the victim 2 machine.

- Service: BadBlue 2.7. Exploit found: `exploit/windows/http/badblue_passthru`. Get access to the target machine with a meterpreter session. Set the meterpreter bind_tcp payload instead of reverser_tcp in this case, as we want to connect to the target machine instead of forcing the target to connect to us. Remember to set the target to the appropiate target version.

- Let's try local enumeration on victim 2: `sysinfo`, `getuid`, `getprivs`.

**Note**: At this point we can set a name for the session of id 2 by running `sessions -n victim-2 -i 2`.

Flag: c46d12f28d87ae0b92b05ebd9fb8e817
