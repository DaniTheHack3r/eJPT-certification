# Establishing Persistence on Linux

+ Persistence consists of techniques that adversaries use to keep access to systems across restarts, changed credentials, and other interruptions that could cut off their access.

+ Gaining an initial foothold is not enough, you need to setup and maintain persistent access to your targets.

**Note**: If you gain initial access through a vulnerability and that vulnerability is patched, you will lose your access. That's why persistence is important.

+ The persistence techniques we can utilize will depend on the target configuration.

+ We can utilize various post exploitation persistence modules to ensure that we always have access to the target system.

## Laboratory

- Start the postgresql server by running `service postgresql start`.

- Start the msfconsole and check the database status.

- Create a new workspace and import your nmap scan results. We can name it Persistence for this example.

- Set globally the target IP with `setg RHOSTS $TARGET_IP`, do this for the RHOST option as well.

- We can start by using db_nmap to start scanning the target machine. Or you can import them from an external xlm nmap result file.

**Note**: The target machine is the next ip after your ip address. If your ip is x.x.x.2, the target IP will be x.x.x.3.

- We have been provided with ssh credentials to directly access the target machine. Use the `auxiliary/scanner/ssh/ssh_login` module. It will provide us with a shell session.

- Start by performing some basic enumeration: `whoami`, `uname -r`, `cat /etc/*issue`.

- Upgrade the session to meterpreter using `session -u $SESSION_ID`.

- We are now logged as someone that is not root and we want to elevate our privileges. Start by performing some extra local enumeration by running `ps aux`. We will find that the root user ran a script which is not present on basic linux baseline, called `/bin/check-down`. By enumerating the content of this file we see that it executes a binary called `chkrootkit`. This binary is vulnerable to a local privilege escalation for versions < 0.50.

- We are going to use the module `exploit/unix/local/chkrootkit` to exploit the vulnerability. By setting the session, chkrootkit directory, and the payload options, we should have a shell session with root privileges by exploiting a vulnerability on chkrootkit.

**Note**: To establish persistence in linux, we will need root privileges in most cases.

- One way to establish persistence is a manual technique where we will create a backdoor user. Useful if the machine is running ssh or another remote administration service. We can create a regular user that will blend quite well around other service accounts. For example ftp or www-data if they don't exist and we can change the home directory and the shell depending on what we need. And we will add it to the root group, so it is a privileged user, and we give it a password. This will allow us to get access using ssh. We could also give it a different id as well and a different group id.

- Now there are a lot of modules that can help you establish persistence in linux: 

    + `post/linux/local/apt_package_manager_persistence`: It is a good module but it is not reliable as persistence will depend on the execution of certain binaries.
    + `post/linux/local/cron_persistence`: This module is good, but not good enough as it could be suspicious and can be easily detected by administrators on the system. However, it might not work on some targets.
    + `post/linux/local/service_persistence`: This module has a range os distributions and versions where it will work, so take into consideration that when trying to use it.
    + `post/linux/local/sshkey_persistence`: It will add a public key to the authorized_keys file in all users inside the linux machine. This will allow us to log in as any of the users using its corresponding private key if the server has ssh enabled. This is an excellent way of establishing persistence as it will also be difficult to spot and most users rarely access the .ssh directory.
