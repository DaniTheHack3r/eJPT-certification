# Meterpreter Fundamentals

## Post Exploitation

+ Post exploitation refers to the actions performed on the target system after initial access has been obtained.

+ The post exploitation phase of a penetration test consists of various techniques like:
    - Local Enumeration
    - Privilege Escalation
    - Dumping Hashes
    - Establishing Persistence
    - Clearing Your Tracks
    - Pivoting

## Meterpreter

+ The Meterpreter (Meta-Interpreter) payload is an advanced multi-functional payload that operates via DLL injection and is executed in memory on the target system, consequently making it difficult to detect.

+ It communicates over a stager socket and provides an attacker with an interactive command interpreter on the target system that facilitates the execution of system commands, file system navigation, keylogging and much more.

+ Meterpreter also allows us to load custom script and plugins dynamically.

+ MSF provides us with various types of meterpreter payloads that can be used based on the target environment and the OS architecture.

**Note**: Meterpreter works differently on linux and on windows in regards of advanced functionalities.

## Laboratory

- Start the postgresql server by running `service postgresql start`.

- Start the msfconsole and check the database status.

- Create a new workspace and import your nmap scan results. We can name it vsftpd2.3.4 for this example.

- Set globally the target IP with `setg RHOSTS $TARGET_IP`, do this for the RHOST option as well.

- We can start by using db_nmap to start scanning the target machine. Or you can import them from an external xls nmap result file.

**Note**: The target machine is the next ip after your ip address. If your ip is x.x.x.2, the target IP will be x.x.x.3.

- We have a apache web server running on port 80 and a mysql database running on port 3306. We are goint to start trying to exploit the web server, we need to see what the server is serving, and for that, we can use the curl command. It should be running XODA which is easily exploitable using metasploit `exploit/unix/webapp/xoda_file_upload`. Remeber to set the TARGETURI to the root of the web server. After succesful exploitation, we should get a meterpreter session.

**Note**: Meterpreter works as an advanced version of the cmd prompt in windows targets and as an advanced version of the linux terminal on linux targets.

- Let's start by performing some local enumeration by running `sysinfo`, `getuid`. If you wan to see a full list of commands, you can run the `help` command.

**Note**: Meterpreter sessions on windows target have a few more commands like keyloggin, recording from the webcam, automatic privilege escalation, hash dump, etc.

- Now we are going to send the session to the background with the command `background`. Run the `sessions -h` from the msfconsole to get some info about actions we can perform with the command `session`. For example, we can execute commands without interacting with the meterpreter session directly `sessions -C sysinfo -i 1` where `-i 1` is the session ID. And we can provide a session with a name using `sessions -n xoda -i 1`.

- Now let's go back to the meterpreter session we have open and try to navigate through the file system. You can do this like in a bash shell. We can cat files as we were in linux using the `cat` command. We can edit a file using the command `edit` and it will display a vim like editor.

- We can download files using the `download` command to download a zipped flag which has a password `56784`. Put the meterpreter session in the background and run the unzip command from your computer and extract the file. This file has instructions of where the real flag is, which include getting the md5 hash of /bin/bash inside the target system.

- To get the MD5 hash of the /bin/bash binary, we can get inside the meterpreter session again and run `checksum md5 /bin/bash` and that's essentially the flag we are look for.

- Now we want to dump the environment variables, we can do this by running `getenv PATH` command. Now if we want to get the env variables assigned to the current user, we can run the command `getenv TERM`.

**Note**: as we have access to a service account, there shouldn't be variables assigned to this particular user, this is because service account doesn't have the need to have env variables in a terminal environment.

- To look for files in the target machine, we can use the `search` command `search -d /usr/bin -f *backdoor*`, `search -f *.jpg`, `search -f *.php`.

- If we want to pop a shell in the target system, a native shell like cmd prompt in windows or bash in linux, we can run the command `shell` from meterpreter. In linux, we won't get any output but the shell will run and work properly and from that shell we can run `/bin/bash -i` to startup a bash shell.

- To list all processes in the target machine, we can use the command `ps`. From here, we can use the information given by the ps command to migrate to other processes. Using for example `migrate $PID` or `migrate -N $PROCESS_NAME`.

- We can also execute commands using the `execute` command `execute -f $CMD`. For example `execute -f ifconfig` but it won't return any output.
