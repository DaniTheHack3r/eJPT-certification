# Exploiting WinRM (Windows Remote Management Protocol)

+ Windows Remote Management (WinRM) is a Windows remote management protocol that can be used to facilitate remote access with Windows systems.

**Note**: A simple example of another remote management protocol would be ssh.

+ WinRM is typically used in the following ways:
    - Remotely access and interact with Windows hosts on a local network.
    - Remotely access and execute commands on Windows systems on the internet.
    - Manage and configure Windows systems remotely.

+ WinRM typically uses TCP port 5985 and 5986 (HTTPS).

+ WinRM implements access control and security for communication between systems through various forms of authentication.

+ We can utilize the MSF to identify WinRM users and their passwords as well as execute commands on the target system.

+ We can also utilize a MSF WinRM exploit module to obtain a meterpreter session on the target system.

**Note**: In this lesson we are not going to try to exploit vulnerable WinRM but WinRM itself by finding legitimate credentials.

## Laboratory

- Start the postgresql server by running `service postgresql start`.

- Start the msfconsole and check the database status.

- Create a new workspace and import your nmap scan results or run the tcp port scan from msfconsole if you want to. We can name it WinRM for this example.

**Note**: When performing the tcp scan with nmap, remember to include the corresponding port range to include winRM ports 5985 and 5986. You can also specify the whole port range (65.535) with `-p-`.

**Note**: Remember that WinRM could be working over http and https. Take that into consideration when looking at ports 5985 and 5986.

- Set globally the target IP with `setg RHOSTS $TARGET_IP`, do this for the RHOST option as well.

- Now we are going to check the authentication methods available on the target for WinRM. We can achieve this by using the module `auxiliary/scanner/winrm/winrm_auth_methods`. The output should show us if we can perform a bruteforce attack on the target. If the Basic Protocol is supported, we could try to brute force the credentials.

**Note**: We can perform a search for this module using `search type:auxiliary winrm`.

**Note**: Even if winrm is working over port 5985, it will act as a http server. The default path or uri will not be the root directory of the http server, it will be `/wsman`. We can check this by open up a browser, even if it doesn't return anything, it should not return a 404.

- Now we are going to use the `auxiliary/scanner/winrm/winrm_login`. Recommended user and password files would be: `/usr/share/metasploit-framework/data/wordlists/common_users.txt` and `/usr/share/metasploit-framework/data/wordlists/unix_passwords.txt`. In this example, we should be able to find legitimate credentials with these lists.

- Now we are going to use the module `auxiliary/scanner/winrm/winrm_cmd`. Here we will need to set the password and username we found. And we can edit the command is going to be sent as payload through winrm.

- Now we are going to use the module `exploit/windows/winrm/winrm_script_exec`. We are going to use it to inject a meterpreter payload into the target and establish a command line session. We will need to specify the USERNAME and PASSWORD in this module. Depending on the user we use to establish the meterpreter session, it could probably be able to get NT AUTHORITY\SYSTEM privileges.

**Note**: We can use the default payload which is the 32 bit version of meterpreter as we don't really know the target system architecture.

**Note**: If you see an error similar to this: `RuntimeError [BUG] Unexpected node test: <:child>: <[:qname, "w", "Items"]>`. The reason could be that you need to set the FORCE_VBS option to force the use of VBS CmdStager instead of the PowerShell CmdStager.

**Note**: Even if you use the 32 bit version of the meterpreter payload, it will try to automatically migrate to a x64 process.
