# Exploiting Windows MS17-010 SMB Vulnerability

+ EternalBlue (MS17-010/CVE-2017-0144) is the name given to a collection of Windows vulnerabilities and exploits that allow attackers to remotely execute arbitrary code and gain access to a Windows system and consequently the network that the target system is a part of.

+ The EternalBlue exploit was developed by the NSA (National Security Agency) to take advantage of the MS17-010 vulnerability and was leaked to the public by a hacker group called the Shadow Brokers in 2017.

+ The EternalBlue exploit takes advantage of a vulnerability in the Windows SMBv1 protocol that allows attackers to send specially crafted packets that consequently facilitate the execution of arbitrary commands.

+ The EternalBlue exploit was used in the WannaCry ransomware attack on June 27, 2017 to exploit other Windows systems across networks with the objective of spreading the ransomware to as many systems as possible.

+ This vulnerability affects multiple versions of Windows:
    - Windows Vista
    - Windows 7
    - Windows Server 2008
    - Windows 8.1
    - Windows Server 2012
    - Windows 10
    - Windows Server 2016

+ Microsoft released a patch for the vulnerability in March, 2017, however, many users and companies have still not yet patched their systems.

+ The EternalBlue exploit has a MSF auxiliary module that can be used to check if a target system if vulnerable to the exploit and also has an exploit module that can be used to exploit the vulnerability on unpatched systems.

+ The EternalBlue exploit module can be used to exploit vulnerable Windows systems and consequently provide us with a privileged meterpreter session on the target system.

## Laboratory

This laboratory cannot be implemented as a online lab, so we need to deploy a home lab in order to run it.

- Start the postgresql server by running `service postgresql start`.

- Start the msfconsole and check the database status.

- Create a new workspace and import your nmap scan results or run the tcp port scan from msfconsole if you want to. We can name it EternalBlue for this example.

- Set globally the target IP with `setg RHOSTS $TARGET_IP`, do this for the RHOST option as well.

- Seeing the results of nmap, we see that the target is currently running ports 135, 139 and 445. Which means is a windows host with smb enabled. Based on that, we will use the auxiliary module `auxiliary/scanner/smb/smb_ms17_010` to scan the target and get to know if it is vulnerable. For this module, we only need to setup the RHOSTS option. Then hit run.

**Note**: You can search for that module using the command `search type:auxiliary name:EternalBlue`.

**Note**: It is recommended to do a full sweep on a network using this auxiliary module to see if any of the targets is vulnerable to the EternalBlue vulnerability. You can do this using metasploit.

- If the target is likely vulnerable, we can now try to exploit it using the exploit module `exploit/windows/smb/ms17_010_eternalblue`. Here we only need to set the RHOSTS and be careful about the payload, the default payload is an x64 payload, if the target is a 32 bit windows, we need to specify it as well. Then hit run.

**Note**: We can search for this exploit module using `search type:exploit name:EternalBlue`.

- When it finishes, you should get a meterpreter session running. You can run sysinfo and getuid to enumerate some info about the target system.
