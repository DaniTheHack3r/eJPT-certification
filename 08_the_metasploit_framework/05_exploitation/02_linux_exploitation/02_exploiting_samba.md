# Exploiting Samba

+ SMB (Server Message Block) is a network file sharing protocol that is used to facilitate the sharing of files and peripherals between computers on a local network (LAN).

+ SMB uses port 445 (TCP). However, originally, SMB ran on top of NetBIOS using port 139.

+ Samba is the Linux implementation of SMB, and allows Windows systems to access Linux shares and devices.

+ Samba V3.5.0 is vulnerable to a remote code execution vulnerability, allowing a malicious client to upload a shared library to a writable share, and then cause the server to load and execute it.

**Note**: Shared Libraries are the linux equivalent of a dll in windows.

## Laboratory

- Start the postgresql server by running `service postgresql start`.

- Start the msfconsole and check the database status.

- Create a new workspace and import your nmap scan results. We can name it samba for this example.

- Set globally the target IP with `setg RHOSTS $TARGET_IP`, do this for the RHOST option as well.

- We can start by using db_nmap to start scanning the target machine. Or you can import them from an external xls nmap result file.

**Note**: The target machine is the next ip after your ip address. If your ip is x.x.x.2, the target IP will be x.x.x.3.

- We are going to start performing a quick search to see al exploit modules related to Samba `search type:exploit name:samba`. And we are going to pay attention to the module `exploit/linux/samba/is_known_pipename`. If we select the module, we only need to set up the RHOSTS, SMB_FOLER and SMB_SHARE_NAME. The module comes with its own payload by default, so there's no need to upgrade it.

- With the RHOSTS set, we can check if the target machine is vulnerable by running the command `check`. It will tell you if the target is vulnerable. Then hit run and you should get a command shell session.

**Note**: Check the info of the module as it can have relevant information, for example, it says it works on versions 3.5.0 to 4.4.14, 4.5.10 and 4.6.4. So, not only 3.5.0.

**Note**: Remember you can run `/bin/bash -i` and you will get a bash session.

- Now we are going to upgrade the shell session to a meterpreter session, and this can be achieved by using a post-exploitation module called `post/multi/manage/shell_to_meterpreter`. Here we need to consider we should already have access to the target system and an active session. We need to set the LHOST (we can specify the name of the interface name as well) and we need to specify the identifier of the session we want to upgrade. It could give you a little error but it should be fine. If we run `sessions` the session should be updated to a meterpreter session.

**Note**: uid=0 specifies the root user.
