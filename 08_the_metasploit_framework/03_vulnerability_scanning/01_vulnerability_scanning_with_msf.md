# Vulnerability Scanning with MSF

+ Vulnerability scanning & detection is the process of scanning a target for vulnerabilities and verifying whether they can be exploited.

+ So far, we have been able to identify and exploit misconfigurations on target systems, however, in this section we will be exploring the process of utilizing auxiliary and exploit modules to scan and identify inherent vulnerabilities in services, operating systems and web applications.

+ This information will come in handy during the exploitation phase of this course.

+ We will also be exploring the process of utilizing third party vulnerability scanning tools like Nessus and how we can integrate Nessus functionality in to the MSF.

## Lab Environment 

+ For the purposes of demonstrating the vulnerability scanning process, we will be utilizing an intentionally vulnerable virtual machine called Metasploitable3 that is based on Windows Server 2008.

+ Metasploitable3 was developed by Rapid7 to demonstrate how MSF can be used to perform exploitation of a Windows System.

+ Instructions on how this VM can be setup can be found here: https://bit.ly/3kASwns

## Laboratory

This laboratory is suppoused to be setup as a home lab. So the main idea is to properly setup a simple virtual machine with metasploitable3 in the same network as our kali machine.

- First, get the target IP address, either by looking at it from the target machine or by performing a ping sweep using nmap -sn.

- Start the postgresql server by running `service postgresql start`.

- Start the msfconsole and check the database status.

- Create a new workspace and import your nmap scan results. We can name it MS3 for this example.

- Set globally the target IP with `setg RHOSTS $TARGET_IP`, do this for the RHOST option as well.

- We will start by performing nmap scan through the command `db_nmap -sS -sV -O $TARGET_IP`.

- Run `hosts` command to get info from nmap about the host.

- Run `services` to list all services scanned with nmap.

- We could try to look for vulnerabilities manually using the `search` command in the msfconsole. For example, Mbl3 has an http server running on port 80 called `Microsoft IIS` in its version 7.5. If we search for an exploit for that specific version we could face 2 scenarios: There are no exploits disclosed for that particular version, or there is not a msf module available to exploit it.

- To see a little bit more about what versions the exploit could be used for, we will select the exploit module with the `use` command and then run the command `info`. In this case, we could see that GlassFish is running on the target machine with version 4.0. However, the exploit module doesn't have any relevant information about the versions it has been tested on in its name or description, so we need to read its info page.

**Note**: Remember to check the payload any time you are going to use the exploit module, the module could set a linux payload when we are targeting a windows machine and that could backfire and even crash the service.

**Note**: Doing vulnerability search manually is rather a tedious process and that's why we make use of scanning tool that aid us during this process.

**Note**: We could try to exploit GlassFish in order to see how the module works if we want to.

- Apart from the `search` command in the metasploit framework, we could also use the `searchsploit` utility which comes prepackaged with kali linux and limit the results to only show msf modules. In this case, we could take a look at the SMB vulnerability found in these windows machines `searchsploit "Microsoft Windows SMB" | grep -e "Metasploit"`. We need to pipe the output of searchsploit through the grep utility in order to filter only msf modules.

- In this case, Eternal Blue (MS17_010) is the vulnerability we are interested on. We see that the module exists in the metasploit framework thanks to the searchsploit utility. So if we come back to the msfconsole, we could try searching for all module related to eternalblue. There are times where there's also an auxiliary module that could help us scan the target to see if it is vulnerable. For example for EternalBlue the module is `auxiliary/scanner/smb/smb_ms17_010`. By running this module we can get to know if the target is vulnerable to Eternal Blue.

- Afterward, we can use the module `exploit/windows/smb/ms17_010_eternalblue` to exploit the target and get a meterpreter session. 

### Metasploit Autopwn plugin

- You can take a look at this plugin in its own repository `https://github.com/hahwul/metasploit-autopwn`. It will help automatically sweep all services in our metasploit db and look for vulnerabilities easily. Follow installation instructions on the github page.

- Once installed, load it into msfconsole by running `load db_autopwn`.

**Note**: db_autopwn is no longer supported by metasploit, but it still works perfectly fine and can be used to make the process of finding vulnerabilities easy. The reason it shows that error is that it was supported previously along msfconsole, but that's not the case anymore as it is maintained as a third party plugin.

**Note**: This plugin works on all the information you have enumerated in the metasploit db.

- If we run `db_autopwn` we will get some information about how to use the module. In this case let's start with `-p` which will list all modules by open port. With `-PI` we can narrow down the list by passing the ports we are interested in, like port 445. You will then need to filter the output by yourself (os for example).

### Analyze command

- Just by running `analyze` command will help you determine vulnerabilities for the services you have listed in your database.
